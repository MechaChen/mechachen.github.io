---
sidebar_label: '[CORS] 1. CORS æ˜¯ä»€éº¼ï¼Ÿ é˜»æ“‹ CSRF çš„åˆ©å™¨'
title: '[CORS] 1. CORS æ˜¯ä»€éº¼ï¼Ÿ é˜»æ“‹ CSRF çš„åˆ©å™¨'
tags:
  - CORS
  - Security

---


## ä»€éº¼æ˜¯ CORSï¼Ÿ

å…ˆä¾†èªªæ˜ä¸€ä¸‹ä»€éº¼æ˜¯ `Origin`ï¼š

`Origin`: ç”± `protocol` + `host` + `port`ï¼Œex:
	- https://www.benson-chen.com
	- http://www.mecha-chen.com:80
	- https://www.hello-world.com:443

å¦‚æœ fetch, XMLHTTPRequest çš„ api origin ä¸ä¸€æ¨£ï¼Œå°±æœƒè¢« `Cross Origin Resource Sharing (CORS)` policy é˜»æ“‹

<br />

:::caution `script`, `img` çš„ src ä¸åœ¨æ­¤é™åˆ¶
å› ç‚ºåƒ `script`, `img` çš„ src åªæ˜¯å–å¾—è³‡æºï¼Œå° Server æ²’æœ‰ä»€éº¼å®‰å…¨ä¸Šçš„ç–‘æ…®ï¼Œæ‰€ä»¥æ²’æœ‰åœ¨ CORS policy çš„é™åˆ¶ç¯„åœè£¡
:::

<br /><br />

## ç‚ºä»€éº¼è¦æœ‰ CORSï¼Ÿ

é¿å… **CSRF (Cross-Site Request Forgery)**ï¼Œèˆ‰ä¾‹ä¾†èªªï¼š

<figure>
  <img src="/img/csrf.png" width="500" />
</figure>

1. User ç™»å…¥äº† bank.com
2. bank.com å°‡éŠ€è¡Œçš„å¸³è™Ÿ cookie å­˜åœ¨ User çš„ç€è¦½å™¨ï¼Œç€è¦½å™¨æ‰€æœ‰çš„ tab éƒ½å­˜å–å¾—åˆ°
3. User é€²å…¥ evil.com (å½é€ çš„æƒ¡æ„ç¶²ç«™)
4. evil.com å˜—è©¦å»å­˜å–äº† bank.com çš„è³‡è¨Šï¼Œå› ç‚ºæœ‰ cookie çš„å­˜åœ¨ï¼Œæ‰€ä»¥æ‰“ api æœƒæˆåŠŸ
5. Hacker å°±æˆåŠŸåˆ©ç”¨ evil.com å–å¾— User çš„éŠ€è¡Œå¸³æˆ¶è³‡è¨Šäº†

<br />

æœ‰äº† CORSï¼Œå› ç‚º `evail.com` è·Ÿ `bank.com` æ˜¯ä¸ä¸€æ¨£çš„ domainï¼Œå°±å¯ä»¥é¿å… `evil.com` å–å¾— `bank.com` çš„ api responseï¼Œä¸¦è§£æ±ºæ‰ CORS äº† ğŸŒˆğŸŒˆğŸŒˆ


<br /><br />

## é™·é˜±: Server å…¶å¯¦é‚„æ˜¯æœƒè™•ç† request

é›–èªªæœ‰äº† CORS ä¹‹å¾Œï¼Œå¯ä»¥é˜»æ“‹ CSRFï¼Œå¯æ˜¯é˜»æ“‹çš„æ–¹å¼åªæ˜¯

<br />

> **Browser ä¸æŠŠ "å·²ç¶“å–å¾— respones çš„çµæœ" å›å‚³çµ¦ä½ çœ‹**

<br />

é©šä¸é©šå–œï¼Œæ„ä¸æ„å¤– ğŸ˜ˆğŸ˜ˆğŸ˜ˆ

<img src="https://memeprod.ap-south-1.linodeobjects.com/user-gif-thumbnail/92a94a6729ddc1ad62ef6041fa5e0461.gif" width="400" />

<br /><br /><br />

æ€éº¼èªªå‘¢ï¼Ÿ ä½ æœƒçœ‹è¦‹çš„éŒ¯èª¤è¨Šæ¯å¦‚ä¸‹ï¼š

:::danger CORS error
request has been blocked by CORS policy: No â€˜Access-Control-Allow-Originâ€™ header is present on the requested resource
:::

<br />

æœ‰æ²’æœ‰ç™¼ç¾äº®é»ï¼Ÿ `Access-Control-Allow-Origin` æ˜¯ Server çš„ response æ‰æœƒåŠ ä¸Šçš„ headerï¼Œè¡¨ç¤º Server å…¶å¯¦å·²ç¶“è™•ç†å®Œ request äº†

é‚£å¦‚æœæˆ‘å€‘çš„ request å…¶å¯¦æœƒå»æ›´æ”¹ DB çš„è³‡æ–™ï¼Œåƒæ˜¯ `PUT /user/:id` æˆ–æ˜¯ `DELETE /user/:id` å‘¢ï¼Ÿ

é‚£é€™æ™‚å€™å°±æ‚²åŠ‡äº†ï¼Œå°±ç®—æœ‰ CORS çš„ä¿è­·ï¼ŒServer çš„ DB è³‡æ–™é‚„æ˜¯æœƒè¢«ç æ‰ï¼Œæ‰€ä»¥å‘¢ï¼Ÿ åˆæœ‰å¦å¤–ä¸€å€‹æ©Ÿåˆ¶å¹«æˆ‘å€‘å»å€åˆ† requestï¼Œä¾†é‡å°ä¸åŒå®‰å…¨ç¨‹åº¦çš„ request åšä¸åŒçš„è™•ç†ï¼Œåˆ†åˆ¥æ˜¯ **ç°¡å–®è«‹æ±‚** & **ä¸€èˆ¬è«‹æ±‚**ï¼Œæˆ‘å€‘æ¥ä¸‹ä¾†å°±æœƒé‡å°é€™ 2 ç¨®è«‹æ±‚ä¾†åšèªªæ˜

<br /><br />

## ç°¡å–®è«‹æ±‚

åœ¨åªç¬¦åˆç‰¹å®šç°¡å–®å…§å®¹çš„æ¢ä»¶ä¸‹ï¼Œå› ç‚ºå®‰å…¨æ€§ç–‘æ…®æ¯”è¼ƒä½ï¼Œæœƒç›´æ¥å° Server ç™¼é€è«‹æ±‚

<br />

### è«‹æ±‚å…§å®¹

- Method: `GET`, `POST`, `HEAD`
- Request header: 
	- `Accept`
	- `Accept Language`
	- `Content-Language`
	- `Content-Type`: `application/x-www-form-urlencoded`, `multipart/form-data`, `text/plain`



## ä¸€èˆ¬è«‹æ±‚

å¦‚æœä¸ç¬¦åˆä¸Šè¿°ç°¡å–®è«‹æ±‚çš„æ¢ä»¶ï¼Œæœƒå° Server å…ˆç™¼é€ Preflight request ï¼Œå†ç™¼é€ä¸€èˆ¬ request


### Preflight Request (é æª¢è«‹æ±‚)

æœƒå…ˆå° Server ç™¼é€é æª¢è«‹æ±‚ï¼Œè¡¨ç¤ºæœ‰å“ªä¸€äº› HTTP method çš„ optionsï¼Œæ•…ç™¼é€çš„ request ç‚º HTTP `OPTION` methodï¼Œç¯„ä¾‹å¦‚ä¸‹

```plaintext
OPTIONS /data/
Host: othersite.com
Origin: https://shubo.io
Access-Control-Request-Method: POST
Access-Control-Request-Headers: X-MY-CUSTOM-HEADER, Content-Type
```

<br /><br />

	
:::info ç‚ºä»€éº¼æ˜¯å« OPTIONS å‘¢ï¼Ÿ è€Œä¸æ˜¯ CHECK ä¹‹é¡çš„ï¼Ÿ
HTTP æ–¹æ³•çš„å‘½åé€šå¸¸èˆ‡å…¶åŠŸèƒ½å’Œç›®çš„æœ‰é—œã€‚å°æ–¼ "OPTIONS" é€™å€‹åç¨±ï¼Œå…¶èƒŒå¾Œçš„åŸå› å¯ä»¥å¾å…©å€‹æ–¹é¢ä¾†ç†è§£ï¼š
1. **æä¾›é¸é …ï¼ˆOptionsï¼‰**ï¼šOPTIONS æ–¹æ³•çš„ä¸»è¦ç›®çš„æ˜¯æä¾›é—œæ–¼ç›®æ¨™è³‡æºå¯ç”¨çš„é€šä¿¡é¸é …ã€‚æ›å¥è©±èªªï¼Œå®ƒå‘Šè¨´å®¢æˆ¶ç«¯å¯ä»¥å°ç‰¹å®šè³‡æºé€²è¡Œå“ªäº›æ“ä½œï¼Œé€™äº›æ“ä½œå°±æ˜¯å®¢æˆ¶ç«¯çš„â€œé¸é …â€ã€‚æ‰€ä»¥ï¼Œå¾é€™å€‹è§’åº¦ä¾†çœ‹ï¼Œâ€œOPTIONSâ€é€™å€‹åç¨±åæ˜ äº†é€™å€‹æ–¹æ³•çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå³æä¾›æœ‰é—œè³‡æºçš„å¯ç”¨æ–¹æ³•å’Œé™åˆ¶çš„ä¿¡æ¯
:::


<br /><br />


### example:  js POST fetch

```javascript
fetch('https://othersite.com/data/', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json', // éç°¡å–®è«‹æ±‚
    'X-CUSTOM-HEADER': '123'
  }
})
```


#### Preflight request

å‚³é€
- `OPTIONS` method: è·Ÿ Server èªªæˆ‘æƒ³è¦ç¢ºèªå“ªäº› method åœ¨æ­¤ domain ä¸‹å¯ä»¥ç”¨
- `Host`: Client çš„ host
- `Origin`: Client çš„ domain
- `Access-Control-Request-Method`: Client è¦å…è¨±çš„ method
- `Access-Control-Request-Headers`: Client è¦å…è¨±çš„ headers

```plaintext
```plaintext
OPTIONS /data/
Host: othersite.com
Origin: https://shubo.io
Access-Control-Request-Method: POST
Access-Control-Request-Headers: X-MY-CUSTOM-HEADER, Content-Type
```

<br />

#### Preflight response

- `Access-Control-Allow-Methods`: Server å…è¨±çš„ HTTP æ–¹æ³•ã€‚
- `Access-Control-Allow-Headers`: Server å…è¨±çš„éã€Œç°¡å–®ã€headerã€‚

```plaintext
Access-Control-Allow-Methods: POST
Access-Control-Allow-Headers: X-MY-CUSTOM-HEADER, Content-Type
```

<br />

#### ä¸€èˆ¬ Request & Response

request:

```plaintext
POST /data/
Host: othersite.com
Origin: https://shubo.io
Content-Type: application/json
X-MY-CUSTOM-HEADER: 123
```

<br />

response:

```plaintext
Access-Control-Allow-Origin: https://shubo.io
```

<br /><br />


## çµè«–

1. æœ‰äº† CORSï¼Œå°±å¯ä»¥é˜»æ“‹ CSRFï¼Œé¿å… hacker ä½¿ç”¨ client cookie å–å¾— client ç›¸é—œè³‡è¨Šæˆ–æ›´æ”¹ client ç›¸é—œè³‡è¨Š
2. å³ä¾¿æœ‰äº† CORSï¼Œé‚„æ˜¯æœƒè·Ÿ Server è«‹æ±‚æˆåŠŸï¼Œåªæ˜¯ç°¡å–®è«‹æ±‚çš„è©±ï¼Œresponse æœƒè¢« browser é˜»æ“‹ï¼Œä¸€èˆ¬ request çš„è©±ï¼Œå¦‚æœ preflight response fail äº†ï¼Œæ‰æœƒé˜»æ“‹æ¥ä¸‹ä¾†çš„è«‹æ±‚

<br /><br /><br />


### åƒè€ƒè³‡æº
- [[æ•™å­¸] æ·±å…¥äº†è§£ CORS (è·¨ä¾†æºè³‡æºå…±ç”¨): å¦‚ä½•æ­£ç¢ºè¨­å®š CORSï¼Ÿ - Shubo çš„ç¨‹å¼é–‹ç™¼ç­†è¨˜](https://www.shubo.io/what-is-cors/)
- [CORS æ˜¯ä»€éº¼? ç‚ºä»€éº¼è¦æœ‰ CORS? ï½œExplainThis](https://www.explainthis.io/zh-hant/swe/what-is-cors)
- [é¢è¯•å®˜é—®æˆ‘CORSè·¨åŸŸï¼Œæˆ‘ç›´æ¥ä¸€å¥—æ“ä½œæ–©æ€ï¼ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/6983852288091619342)
- [é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆä¸€ï¼‰-èªè­˜ CSRFï¼ˆCross Site Request Forgeryï¼‰ (cymetrics.io)](https://tech-blog.cymetrics.io/posts/jo/zerobased-cross-site-request-forgery/)
- [ä½ æ˜¯æ€æ ·è§£å†³è·¨åŸŸé—®é¢˜çš„?-é¢è¯•å¿…é—®-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)](https://cloud.tencent.com/developer/article/2132990)
- [å‰ç«¯é¢è¯•æŸ¥æ¼è¡¥ç¼ºâ€“(ä¸‰) è·¨åŸŸåŠå¸¸è§è§£å†³åŠæ³• - å°„æ‰‹çŒ«çš„ä¸ªäººåšå®¢ (shotcat.com)](https://www.shotcat.com/%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95%E6%9F%A5%E6%BC%8F%E8%A1%A5%E7%BC%BA-%E4%B8%89-%E8%B7%A8%E5%9F%9F%E5%8F%8A%E5%B8%B8%E8%A7%81%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/)
- [CORS in 100 Seconds - YouTube](https://www.youtube.com/watch?v=4KHiSt0oLJ0&pp=ygUEQ09SUw%3D%3D)

<br /><br />