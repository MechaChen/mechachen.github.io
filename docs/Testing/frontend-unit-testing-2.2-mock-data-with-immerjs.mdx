---
sidebar_position: 0
sidebar__label: '[Unit Test] 2.2 - åˆ©ç”¨ immer.js è¼•é¬†å»ºç«‹ mock data'
title: '[Unit Test] 2.2 - åˆ©ç”¨ immer.js è¼•é¬†å»ºç«‹ mock data'

---

## å‰è¨€

åœ¨æˆ‘å€‘åšæ¸¬è©¦çš„æ™‚å€™ï¼Œå¸¸å¸¸æœƒéœ€è¦å‡è³‡æ–™ä¾†å¹«æˆ‘å€‘æ¨¡æ“¬çœŸå¯¦çš„æƒ…å¢ƒï¼Œä¹Ÿå°±æ˜¯ mock dataï¼Œåƒæ˜¯
- mock redux state
- mock api response

<br />

ç­‰ç­‰æƒ…å¢ƒï¼Œè€Œé€™äº›æƒ…å¢ƒï¼Œéœ€è¦æ¨¡æ“¬çš„ mock data é€šå¸¸æœƒå¾ˆé¾å¤§ï¼Œå…‰æ˜¯è¦å®£å‘Šä¸€å€‹å‡è³‡æ–™å°±è¦è€—è²»éå¸¸å¤šçš„æ™‚é–“å’Œç²¾ç¥ï¼Œè€Œä¸”å†åŠ ä¸Šæˆ‘å€‘å¸¸å¸¸æœƒéœ€è¦å¤§é«”ä¸Šä¸€æ¨£çš„ mock dataï¼Œåªéœ€è¦ä¿®æ”¹ 1, 2 å€‹ key pairï¼Œé€™æ˜¯å¾Œï¼Œå°±ç®—å¯ä»¥åˆ©ç”¨è¤‡è£½è²¼ä¸Šçš„æ–¹æ³•å»ä¿®æ”¹ï¼Œå›é ­å†å›ä¾†ç¶­è­·æ™‚ï¼Œå»ä¹Ÿé›£ä»¥é–±è®€å’Œä¿®æ”¹

<br />

é€™æ™‚ï¼Œæˆ‘å°±çªç„¶æƒ³åˆ°ä¹‹å‰æœ‰çœ‹åˆ° redux åˆ©ç”¨ `immer.js` æˆåŠŸè§£æ±ºé€™å•é¡Œï¼ŒRedux toolkit çš„ç™¼æ˜çœŸçš„æ˜¯æˆ‘çš„ life saverï¼Œè®“æˆ‘ä½¿ç”¨ Redux é–‹ç™¼æ™‚å¤§å¤§æ¸›å°‘é–‹ç™¼çš„æ™‚é–“æˆæœ¬ï¼Œæ„Ÿè¬ Redux toolkit å€‹ç™¼æ˜è€… [Mark Erikson](https://github.com/markerikson) ğŸ¥°ğŸ¥°

<br />

æˆ‘å€‘å°±ä¾†ç°¡ä»‹ä¸€ä¸‹ `immer.js` å§

<br />

## `immer.js`

æˆ‘åŸºæ–¼å¥½å¥‡å¿ƒä¹Ÿç¨å¾®äº†è§£äº†ä¸€ä¸‹ `immer.js` æ˜¯ä»€éº¼ï¼ŒåŸä¾†é€™å¥—ä»¶å¯ä»¥è®“æˆ‘å€‘å¯ä»¥æ›´è¼•é¬†çš„è¤‡è£½åŒæ™‚æ”¹å¯« immutable dataï¼Œè€Œä¸”æ˜¯ç”¨ mutable çš„æ–¹å¼æ’°å¯«ï¼Œå®˜ç¶²çš„ç¯„ä¾‹å¦‚ä¸‹ï¼š

- ç•¶æ²’æœ‰ä½¿ç”¨ `immer.js` æ™‚ï¼š
```jsx
const nextState = baseState.slice() // shallow clone the array
nextState[1] = {
    // replace element 1...
    ...nextState[1], // with a shallow clone of element 1
    done: true // ...combined with the desired update
}
// since nextState was freshly cloned, using push is safe here,
// but doing the same thing at any arbitrary time in the future would
// violate the immutability principles and introduce a bug!
nextState.push({title: "Tweet about it"})
```

<br />

- ç•¶æœ‰ `immer.js` æ™‚ï¼š
```jsx
import {produce} from "immer"

const nextState = produce(baseState, draft => {
    draft[1].done = true
    draft.push({title: "Tweet about it"})
})
```

<br />

æˆ‘å€‘å¯ä»¥ä½¿ç”¨ `produce` functionï¼Œå‚³å…¥ä¸€å€‹ callbackï¼Œç„¶å¾Œç”¨é¡ä¼¼ç›´æ¥æ”¹å¯«åŸ array or object çš„æ–¹å¼ï¼Œå®Œæˆæˆ‘å€‘ä¹‹å‰åœ¨ redux æ’°å¯« reducer çš„è¤‡é›œæ“ä½œ!!!

```ts
import { createSlice } from '@reduxjs/toolkit'
import type { PayloadAction } from '@reduxjs/toolkit'

export type CounterStateT = {
  account: {
      company: {
          name: string,
      }
  }
}

const initialState: AccountStateT = {
  account: {
      company: {
          name: '',
      }
  }
  value: 0,
}

export const accountSlice = createSlice({
  name: 'account',
  initialState,
  reducers: {
    setCompanyName: (state, action: PayloadAction<string>) => {
      state.account.company.name = action.payload
    },
  },
})

// Action creators are generated for each case reducer function
export const { setCompanyName } = accountSlice.actions

export default accountSlice.reducer
```

(æ›´è©³ç´°çš„æ•™å­¸è«‹è¦‹[å®˜ç¶²](https://redux-toolkit.js.org/tutorials/quick-start))

<br />

æœ‰äº†é€™é …åˆ©å™¨å¾Œï¼Œæˆ‘å€‘å°±å¯ä»¥éå¸¸å¿«é€Ÿçš„ç”¢ç”Ÿè¤‡é›œçš„ mock dataï¼Œå¦‚ä¸‹é¢ä¾‹å­


<br />

## Testing mock data

### mock redux data

ä»¥ä¸‹æ˜¯æˆ‘åˆ©ç”¨ immer.js æ’°å¯«çš„ç”¢ç”Ÿ mock redux data çš„ api

```js
import produce from 'immer';

import { RootState } from '@/redux/store';

type MockStoreFnT = (store: RootState) => void;

const setupStore = (mockReduxState?: PreloadedState<RootState>) => (
  configureStore({
    reducer: rootReducer,
    preloadedState: mockReduxState,
  })
);

/**
 * Generate mock redux state for unit testing.
 *
 * @param  {MockStoreFnT} mockStoreFn - a callback function which
 *   accepts redux initial state as param,
 *   and use immer.js to get revised redux state
 *
 * @return {RootState} new updated redux state instance
 *
 * @example
 * // gen mock redux state with user email
 * const mockReduxState = genMockReduxState((state) => {
 *    state.account.profile.email = 'test@testdomain.com';
 * })
 */

const genMockReduxState = (mockStoreFn: MockStoreFnT) => {
  // every time will be new redux state instance
  const initialState = setupStore().getState();
  const mockReduxState = produce(initialState, mockStoreFn);
  return mockReduxState;
};

export default genMockReduxState;

```

<br /><br />


æˆ‘å€‘å°±å¯ä»¥åˆ©ç”¨ `genMockReduxstate` å¿«é€Ÿç°¡æ½”çš„ç”¢ç”Ÿ redux state


```js
const mockReduxState: AccountStateT = genMockReduxState((state) => {
    state.account.company.name = 'mock company name';
});
```

<br /><br />

é€™æ¨£æ˜¯ä¸æ˜¯æ¯”ä¸Šè¿°ç°¡å–®çš„éå¸¸å¤šå‘¢ ğŸ˜šğŸ˜š


<br /><br />


### mock api response

æˆ‘å€‘ä¹Ÿå¯ä»¥åˆ©ç”¨ `immer.js` ä¾†ç”¢ç”Ÿ mock api response

```jsx
import produce from 'immer';

const noReviseFn = () => {};

/**
 * Generate a function which generates mock api response for unit testing,
 * and we can pass function to update mock api response.
 *
 * @param  {ApiResT} defaultMockRes - default api return response
 *
 * @return a function which generate specific api default response by default,
 * and revised api response when we revise some property
 */

export default function genMockApiResFactory<ApiExampleResT>(
  defaultMockRes: ApiExampleResT,
) {
  return function genMockApiRes(reviseFn: (res: ApiExampleResT) => void = noReviseFn) {
    return produce(defaultMockRes, reviseFn);
  };
}
```


<br />

```typescript
type ApiExampleResT = {
   prop1: type1,
   prop2: type2,
   prop3: type3,
}
 
const defaultMockApiExampleRes: ApiExampleResT = {
  prop1: 'value1',
  prop2: 'value2',
  prop3: 'value3',
}

const genApiExampleRes = genMockApiResFactory<ApiExampleResT>(
  defaultMockApiExampleRes,
);
```

<br />

æœƒå¤§å¤§æ¸›å°‘æˆ‘å€‘æ’°å¯«æ¸¬è©¦ç¨‹å¼ç¢¼çš„æ™‚é–“

<br />

## ä»Šå¤©å°çµ
æˆ‘å€‘å¯ä»¥åˆ©ç”¨ Redux toolkit èƒŒå¾Œå¯¦ç¾çš„ `immer.js` å¥—ä»¶ï¼Œå¹«æˆ‘å€‘å¿«é€Ÿå»ºç«‹æ¸¬è©¦ç”¨çš„ mock redux state, mock api responseï¼Œè®“æˆ‘å€‘é–‹ç™¼ or ç¶­è­·æ¸¬è©¦ç¨‹å¼ç¢¼æ›´åŠ çš„è¼•é¬†

<br />

### åƒè€ƒè³‡æº
- [immer.js](https://immerjs.github.io/immer/)
- [Redux toolkit](https://redux-toolkit.js.org/tutorials/quick-start)