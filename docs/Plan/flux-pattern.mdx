---
sidebar_label: '[Design Pattern] Flux pattern'
title: '[Design Pattern] Flux pattern'
tags:
  - Design Pattern

---


## ç‚ºä»€éº¼æˆ‘å€‘éœ€è¦ Flux?

### å•é¡Œï¼šæ··äº‚çš„è³‡æ–™æµå‘

åœ¨å‰ç«¯ä¸­ï¼Œæˆ‘å€‘å¸¸ç”¨çš„ MVC çš„åŠŸèƒ½åªæœ‰å¹«æˆ‘å€‘åšåˆ°é—œæ³¨é»åˆ†é›¢ (Separate of Concern; Soc)ï¼Œä¹Ÿå°±æ˜¯å¹«æˆ‘å€‘æŠŠç¨‹å¼ç¢¼åˆ†æˆ Model, View, Controller ä¸‰å€‹éƒ¨åˆ†è€Œå·²ï¼Œ
ä½†ä¸¦æ²’æœ‰é™åˆ¶æˆ‘å€‘çš„ç‹€æ…‹è¦å­˜åœ¨åœ¨å“ªï¼Œä¸¦ä¸”å¦‚ä½•æœ‰è¦å¾‹çš„æ›´æ”¹æˆ‘å€‘çš„ç‹€æ…‹

<figure>
  <img src="/img/mvc.webp" width={500} />
  <figcaption>(åœ–ç‰‡ä¾†æºï¼š<a href="https://tw.alphacamp.co/blog/mvc-model-view-controller" target="_blank">MVCæ¶æ§‹æ˜¯ä»€éº¼ï¼Ÿèªè­˜ Model-View-Controller è»Ÿé«”è¨­è¨ˆæ¨¡å¼</a>)</figcaption>
</figure>

<br />
<br />

åœ¨ MVC ä¸­çš„æ¯å€‹éƒ¨åˆ†éƒ½å¯ä»¥æœ‰è‡ªå·±çš„ç‹€æ…‹ï¼Œä¸”ä»»éƒ¨åˆ†éƒ½å¯ä»¥æ›´æ”¹ä»»ä½•ä½ç½®çš„ç‹€æ…‹ï¼Œä¾‹å¦‚ Model å¯ä»¥æ”¹ View å…§çš„ç‹€æ…‹ï¼ŒController å¯ä»¥æ”¹ Model çš„ç‹€æ…‹

è‹¥æ²’æœ‰è‰¯å¥½çš„æ…£ä¾‹æˆ–ç¶­è­·ï¼Œå°±æœƒé€ æˆè³‡æ–™æµé›£ä»¥æŒæ§ï¼Œå¾ŒçºŒå°ˆæ¡ˆé›£ä»¥ç¶­è­·

( æœ‰ç¶­è­·é jQuery å°ˆæ¡ˆçš„å°±çŸ¥é“ ğŸ¤ª )

<figure>
  <img src="/img/mvc-problem.png" width={500} />
  <figcaption>(åœ–ç‰‡ä¾†æºï¼š<a href="https://www.youtube.com/watch?v=nYkdrAPrdcw&list=PLb0IAmt7-GS188xDYE-u1ShQmFFGbrk0v&t=621s" target="_blank">Hacker Way: Rethinking Web App Development at Facebook</a>)</figcaption>
</figure>

<br /><br />


æ‰€ä»¥ï¼ŒFlux pattern å°±æ˜¯æä¾›ä¸€å€‹æ¦‚å¿µè®“å¤§å®¶å¯ä»¥éµå¾ªï¼Œè®“å¤§è¦æ¨¡çš„é–‹ç™¼å’Œç¶­è­·ä¸Šä¸æœƒæœ‰ä¸çŸ¥é“è³‡æ–™æµå‘çš„å•é¡Œ


<br /><br />

## ä»€éº¼æ˜¯ Flux?

è®“ app çš„è³‡æ–™æµå‘éµå¾ªå–®ä¸€è³‡æ–™æµ (Unidirectional data flow)ï¼Œä»¥è§£æ±º MVC æ²’æœ‰å®šç¾©è³‡æ–™æµå‘çš„ï¼Œé€ æˆç¶­è­·å›°é›£çš„å•é¡Œ

<figure>
  <img src="/img/flux-pattern.png" />
</figure>

<br /><br />

Flux pattern å°±æˆ‘çš„ç†è§£ï¼Œå¯ä»¥åˆ†ç‚ºå…©å€‹éšæ®µï¼š	

1. Singelton patternï¼šå…ˆç”¢ç”Ÿä¸€å€‹å…¨åŸŸçš„ Storeï¼Œé™åˆ¶å…¶å­˜å–çš„æ–¹å¼ã€‚
	æ¥è€…æ‰€æœ‰çš„ View å¯ä»¥é€éä¸€å€‹è¡Œå‹• (Action)ï¼Œä¸¦æ­é…ç‰¹å®šçš„èª¿å‹•è€… (Dispatcher)ï¼Œå»æ”¹è®ŠæŒ‡å®šçš„ Store è£¡çš„ç‹€æ…‹

	exï¼šæˆ‘å€‘é»æ“Šç™»å‡ºæŒ‰éˆ•ï¼Œé‚£æˆ‘å€‘å°±ç§»é™¤å„²å­˜åœ¨å…¨åŸŸçš„ç™»å…¥ç‹€æ…‹

```mermaid
flowchart LR
subgraph Singleton pattern
direction LR
View --> Action
Action --> Dispatcher
Dispatcher --> Store
end
```

<br /><br />

2. Observer patternï¼šæ›´æ–° View æ™‚ï¼Œåœ¨ Store state æ›´æ–°æ™‚é€šçŸ¥æ‰€æœ‰è¨‚é–±çš„ View(s)

	exï¼šæ‰€æœ‰çš„é é¢çŸ¥é“ç™»å…¥ç‹€æ…‹æ”¹è®Šäº†ï¼Œå°±éƒ½æœƒå°å›ç™»å…¥é é¢

```mermaid
flowchart LR
subgraph Observer pattern
direction LR
Store --> id1["View 1"]
Store --> id2["View 2"]
Store --> id3["View 3"]
end
```

<br /><br />

ä¾†é”æˆå–®ä¸€è³‡æ–™æµå‘ï¼Œä»¥ä¸‹å°±ä¾†ä¸€ä¸€èªªæ˜


<br /><br />

### **Singleton**: é™åˆ¶æ”¹è®Š store çš„ state çš„æ–¹æ³•

åˆ©ç”¨ Singleton Pattern è®“æ•´å€‹ app çš„ global store åªæœ‰ä¸€å€‹å–®ä¸€çš„å­˜åœ¨ï¼Œä¸”åªèƒ½é€éæŒ‡å®šçš„ action å»æ”¹è®Š store çš„å€¼ï¼Œé™åˆ¶å…¶å­˜å–ï¼Œè®“æˆ‘å€‘å¯ä»¥é€éä¸€å€‹çµ±ä¸€çš„ state å€å¡Šå»ç¨®æ•´å€‹è³‡æ–™æµçš„æ›´æ–°

<br />

ç”¢ç”Ÿå…¨å±€å–®ä¸€çš„ Storeï¼Œä¸¦ä¸”é™åˆ¶å…¶å­˜å–çš„æ–¹å¼
```js

// Store's state
const initialState = { count: 0 };

// Store's è™•ç†å™¨ (Reducer): æ ¹æ“š action å»æ”¹è®Š store çš„ state
const countReducer = (state = initialState, action) => {
	switch (action.type) {
		case 'INCREMENT':
			return { count: state.count + 1 };

		case 'DECREMENT':
			return { count: state.count - 1 };

		default:
			return state;
	}
}

const store = createStore(countReducer);
export store;
```

<br />

åˆ©ç”¨ action è¢« dispatch çš„æ–¹å¼ï¼Œå»æ”¹è®Š store çš„ state

```js
// Update store's state

import store from './store';

// Actions
const actions = {
	increment: { type: 'INCREMENT' },
	decrement: { type: 'DECREMENT' },
};

// Dispatcher dispatch action
store.dispatch(actions.increment);

// store's state changed
store.getState(); // { count: 1 }
```

<br /><br />

### **Observer pattern**: é€šçŸ¥æ‰€æœ‰çš„ viewsï¼Œstore state æœ‰è®ŠåŒ–äº†

åœ¨ Redux çš„ç¨‹å¼åŸå§‹ç¢¼ä¸­ï¼Œå¯¦ç¾ `dispatch` çš„éƒ¨åˆ†ï¼Œç•¶åˆ©ç”¨ reducer è·Ÿ action ç”¢ç”Ÿæ–°çš„ store state æ™‚ï¼Œå°±æœƒé€šçŸ¥æ‰€æœ‰è¨»å†Šé€™å€‹ store çš„å°è±¡ï¼Œé€šå¸¸æ˜¯ä¸€å€‹ viewï¼Œæˆ–è€… React çš„ä¸€å€‹ Component ç­‰ï¼Œé€™ä¾¿æ˜¯åˆ©ç”¨çš„ Observer pattern çš„æ¦‚å¿µ

<br />

```js
const createStore = (myReducer) => {
	let listener = [];
	let currentState = myReducer(undefined, {});

	...

	const dispatch = (action) => {
		currentState = myReducer(currentState, action);

    // highlight-start
		listeners.forEach((listener) => {
			listener();
		});
    // highlight-end
	};

	return {
		getState,
		dispatch,
		subscribe,
	};
};
```

<br /><br />

## è£œå……: å·¥å» æ¨¡å¼ (Factory pattern) ä¾†ç”¢ç”Ÿå¤šå€‹å–®é«”(Singleton)

åœ¨ Redux ä¸­ï¼Œæ²’æœ‰é™åˆ¶åªèƒ½æ“æœ‰ä¸€å€‹ storeï¼Œåè€Œæä¾›äº†ä¸€å€‹ `createStore` çš„ apiï¼Œè®“æˆ‘å€‘å»å»ºç«‹è‡ªå·±çš„ storeï¼Œé€™ä¾¿æ˜¯ä½¿ç”¨äº† Factory pattern çš„æ¦‚å¿µ

Redux åˆ©ç”¨ function programming çš„ closure æŠ€å·§ï¼Œä¾†åƒ Class ä¸€æ¨£ä¿å­˜è‡ªå·±çš„ç‹€æ…‹ & è‡ªå·±çš„ listeners

<br />

```js
// highlight-start
const createStore = (myReducer) => {
	let listener = [];
	let currentState = myReducer(undefined, {});
// highlight-end

	const getState = () => {...};
	const dispatch = (action) => {...};
	const subscribe = (newListener) => {...};

	return {
		getState,
		dispatch,
		subscribe,
	};
};
```

<br /><br />

è®“æ¯å€‹ store éƒ½å¯ä»¥æ“æœ‰è‡ªå·±çš„ Component, view listenersï¼Œè‡ªå·±çš„ actionï¼Œä¸”æ¯å€‹ store éƒ½æ˜¯ç¨ç«‹çš„ï¼Œä¸æœƒäº’ç›¸å¹²æ“¾


<br /><br />


## çµè«–

1. MVC åªæ˜¯åš separation of concernï¼Œä½†æ˜¯ Flux é è‘—å°è³‡æ–™ä¾†æºçš„å­˜å–é™åˆ¶æ±ºå®šäº†è³‡æ–™çš„æµå‹•æ–¹å¼ï¼Œè®“æˆ‘å€‘æ›´å¯ä»¥æ¸…æ¥šåœ°äº†è§£è³‡æ–™çš„æµå‘ï¼Œè®“å°ˆæ¡ˆåœ¨ scaling æ™‚æ›´å¥½ç¶­è­·
2. å° Singelton çš„ store state åšå­˜å–çš„é™åˆ¶ï¼Œåªèƒ½ç”¨ action æ”¹è®Šï¼Œé”æˆè³‡æ–™å–®ä¸€æµå‘çš„ç›®çš„
3. åˆ©ç”¨ Obeserver pattern çš„æ¦‚å¿µï¼Œè®“ store é€šçŸ¥æ‰€æœ‰çš„ Viewï¼Œé€šçŸ¥æ‰€æœ‰è¨»å†Šçš„ React component


<br /><br />


### åƒè€ƒè³‡æ–™

- [The Mental Model That Helped Me Finally Understand "Flux" - Andy Ray's Blog (andrewray.me)](https://andrewray.me/blog/the-mental-model-that-helped-me-finally-understand-flux)
- [A cartoon guide to Flux. Flux is both one of the most popularâ€¦ | by Lin Clark | Code Cartoons | Medium](https://medium.com/code-cartoons/a-cartoon-guide-to-flux-6157355ab207)
- [Hacker Way: Rethinking Web App Development at Facebook - YouTube](https://www.youtube.com/watch?v=nYkdrAPrdcw&list=PLb0IAmt7-GS188xDYE-u1ShQmFFGbrk0v&t=621s)
- [Flux ç°¡å–®ç¯„ä¾‹ç¨‹å¼ (openai.com)](https://chat.openai.com/c/4ccb1384-4d32-410f-bbc9-71295c7bbde7)
- [How to Use Flux to Manage State in ReactJS - Explained with an Example (freecodecamp.org)](https://www.freecodecamp.org/news/how-to-use-flux-in-react-example/)
- [MVCæ¶æ§‹æ˜¯ä»€éº¼ï¼Ÿèªè­˜ Model-View-Controller è»Ÿé«”è¨­è¨ˆæ¨¡å¼ - ALPHA Camp](https://tw.alphacamp.co/blog/mvc-model-view-controller)

<br /><br />