---
sidebar_label: '[Implement] 60 è¡Œå¯¦ç¾ react-redux'
title: '[Implement] 60 è¡Œå¯¦ç¾ react-redux'
tags:
  - Implement
  - react-redux
  - Observer pattern

---


:::info åŸå§‹ç¢¼åœ¨é€™ï¼Œæ­¡è¿ä¾†ç©ï½
https://github.com/MechaChen/simple-react-redux
:::


## å‰è¨€ï¼šContext çš„æ•ˆèƒ½å•é¡Œ

éå»ç›´æ¥ä½¿ç”¨ Contextï¼Œæœƒé€ æˆ Child component ä¸€ç›´ re-renderï¼Œå°±ç®—è©² component å¯¦éš›ç”¨åˆ°çš„å€¼æ²’æœ‰è®Šæ›´ï¼Œé‚„æ˜¯æœƒé€ æˆ re-render

<br />

ä»¥ä¸€å€‹æœ‰ 3 å€‹ Countersï¼Œéƒ½åŒ…åœ¨ Context åº•ä¸‹çš„æƒ…å¢ƒç‚ºä¾‹ï¼ŒCounters æ¢ä»¶å¦‚ä¸‹
- 2 å€‹ Counters çš„ç‹€æ…‹ä½¿ç”¨ Context æä¾›çš„ count1, count2 state
- 1 å€‹ Counter æœ‰è‡ªå·±çš„ state

<br />

<figure>
  <img src="/img/counters-in-context.png" alt="Counters in Context" />
</figure>

<br />

è‹¥æˆ‘å€‘ä¾†å¯¦éš›æ“ä½œçš„è©±ï¼Œå°±æœƒæœ‰ä»¥ä¸‹çš„æ•ˆæœ

<iframe width="720" height="405" src="https://www.youtube.com/embed/ph8fLb2mE_Y?si=DNC1FN8zcREhUczH" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<br /><br />

æˆ‘å€‘å°±æœƒç™¼ç¾
1. ç•¶æˆ‘å° Context ä¸­çš„ count1 åšåŠ æ¸›æ™‚ï¼Œæ•´å€‹ Context component, Counter1, Counter2 éƒ½æœƒ re-render
2. count2 åŒä¸Š

<br /><br />

æˆ‘å€‘å…ˆä¾†çœ‹çœ‹ç¨‹å¼ç¢¼ç‰‡æ®µï¼Œä¾†äº†è§£ç‚ºä»€éº¼æœƒé€™æ¨£

```jsx
const [count1, setCount1] = useState(0);
const [count2, setCount2] = useState(0);

// ç•¶ count1, count2 æœ‰è®Šå‹•æ™‚ï¼Œ useMemo å°±æœƒç”¢ç”Ÿæ–°çš„ contextValue
// é€ æˆæœ‰æ–°çš„ referenceï¼Œä½¿ ContextCounter1, ContextCounter2 re-render
const contextValue = useMemo(
  () => ({
    count1,
    count2,
    setCount1,
    setCount2,
  }),
  [count1, count2, setCount1, setCount2]
);

return (
  <div>
    <CounterContext.Provider value={contextValue}>
      <h2>In Context</h2>
      <ContextCounter1 />
      <ContextCounter2 />
      <SelfCounter />
    </CounterContext.Provider>
  </div>
);
```

<br />

ä¸»è¦æ˜¯å› ç‚ºä½¿ç”¨ `useContext(context)` æ™‚ï¼Œé‚„æ˜¯æœƒå–åˆ°æ•´å€‹ `contextValue` objectï¼Œç•¶ `contextValue` object å…§æœ‰å€¼è®Šå‹•æ™‚ï¼Œå°±æœƒ re-renderï¼Œé€²è€Œ create ä¸€å€‹æ–°çš„ `contextValue` objectï¼Œå°±ç®—ç”¨äº† `useMemo` ä¹Ÿä¸€æ¨£

<br />

è©³ç´°çš„éç¨‹å¦‚ä¸‹ï¼š
```mermaid
flowchart TB
setCount1 --> id2["count 1 è®Šå‹•"]
id2 --> no-Memo
id2 --> useMemo

subgraph no-Memo
	direction TB
	id31["Parent component re-render"] --> id41["component ç”¢ç”Ÿ<br/>ä¸€å€‹æ–°çš„ `contextValue` object"]
	id41 --> id51["`contextValue` object çš„ reference è®Šäº†"]
	id51 --> id61["ä½¿ç”¨è©² context <br />çš„ component re-render"]
end

subgraph useMemo
	direction TB
	id32["Parent component re-render"] --> id42["useMemo å»çœ‹çœ‹ç›£è½çš„ state <br/>æœ‰æ²’æœ‰åœ¨é€™æ¬¡ re-render è®Šå‹•"]
	id42 --> id52["ç™¼ç¾æœ‰è®Šå‹•ï¼ŒuseMemo ç”¢ç”Ÿ<br/>ä¸€å€‹æ–°çš„ `contextValue` object"]
	id52 --> id62["useContext çš„ component <br />åµæ¸¬åˆ°æ–°çš„ `contextValue` object reference"]
	id62 --> id72["å› ç‚º `contextValue` çš„ reference è®Šäº†ï¼Œ<br />ä½¿ç”¨è©² `contextValue` çš„ component re-render"]
end
```

<br /><br />

æ”¹è®Š context çš„æŸäº› state ï¼Œå»é€ æˆå…¶ä»–æ²’æœ‰ç”¨é€™å€‹ stateï¼Œä½†æœ‰ç”¨åˆ° Conext çš„ components éƒ½æœƒ re-renderï¼Œé€™ä¸æ˜¯æˆ‘å€‘æƒ³è¦çš„æ•ˆæœï¼Œ
å¾ä¸Šè¿°çš„è§£èªªï¼Œæˆ‘å€‘ä¹ŸçŸ¥é“åŸå› äº†ï¼Œä¸»è¦å°±æ˜¯ï¼š

1. **æ•´å€‹ context object çš„åƒè€ƒæœƒä¸€ç›´è®Šå‹•ï¼Œé€ æˆæ‰€æœ‰ä½¿ç”¨æ­¤ context çš„ component ä¸€ç›´ re-render**
2. **ç„¡æ³•åµæ¸¬ç‰¹å®šçš„ context value æ˜¯å¦æœ‰è®Šå‹•ï¼Œé€²è€Œå»æ±ºå®šæ˜¯å¦è¦ re-render**

<br /><br /><br />

ç‚ºäº†è§£æ±ºé€™å€‹å•é¡Œï¼Œ`react-redux` å°±åœ¨å¼•ç”¨ React çš„ Context API æ™‚åšäº†ä¸€äº›å„ªåŒ–å¦‚ä¸‹


<br /><br />

## react-redux æ–¹æ¡ˆï¼šç¢ºå®šç›£è½å€¼æœ‰è®Šå¾Œæ‰ re-render

ä»¥ä¸‹æˆ‘å€‘å°±ä¾†çœ‹çœ‹æ€éº¼æ™‚åšä¸€å€‹ç°¡å–®çš„ `react-redux`ï¼Œä¾†é¿å… Context çš„æ•ˆèƒ½å•é¡Œï¼Œæˆ‘å€‘ä¸»è¦è¦å»ºç«‹ 3 å€‹ apiï¼Œåˆ†åˆ¥æ˜¯ï¼š
1. `Provider`
2. `useDispatch`
3. `useSelector`


<br /><br />

### å¯¦ç¾ `Provider`

ä¸»è¦å°±æ˜¯ç”¨ Redux store ç•¶ä½œ Context çš„ value

1. å»ºç«‹ä¸€å€‹ ReduxContext
2. å»ºç«‹ä¸€å€‹ HOC ç¨±ä½œ `Provider`ï¼Œä¸¦æ¥æ”¶ä¸€å€‹ developer å‚³å…¥çš„ storeï¼Œå¡é€² ReduxContext ä¸­ï¼Œä½œç‚º Redux Context çš„ `value`

<br />

Context

```tsx showLineNumbers
import React, { useContext } from 'react';

const ReduxContext = createContext(null);

function useReduxContext() {
  const store = useContext(ReduxContext);

  if (!store) {
    throw new Error('could not find react-redux context value; please ensure the component is wrapped in a <Provider>')
  }

  return store;
}
```

<br /><br />

Provider

```jsx showLineNumbers
export function Provider({ store, children }) {
  return (
    <ReduxContext.Provider value={store}>
      {children}
    </ReduxContext.Provider>
  );
}
```

<br /><br />


### å¯¦ç¾ `useDispatch`

å–å¾— ReduxContext è£¡é¢çš„ storeï¼Œä¸¦å›å‚³ `store.dispatch`

```tsx showLineNumbers
export function useDispatch() {
  const store = useReduxContext();
  return store.dispatch;
}
```


<br /><br />


### å¯¦ç¾ `useSelector`

react-redux çš„é‡é ­æˆ²ï¼Œå¯¦ç¾ `useSelector` éç¨‹ï¼Œä¸»è¦æ˜¯åˆ©ç”¨
1. å¾ `useReduxContext` å–å¾— storeï¼Œå› ç‚º store æ˜¯å›ºå®šçš„ referenceï¼Œæ•…ä¸æœƒé€ æˆ re-render
2. åˆ©ç”¨ selector é¸å– store ä¸­ç›£è½çš„ state éƒ¨åˆ†
3. åˆ©ç”¨ `useRef` è¨˜ä½ä¸Šæ¬¡ç›£è½çš„ stateï¼Œä¸¦ç”¨ç•¶ä½œæ˜¯å¦è¦ re-render çš„åŸºæº–

<br />

ä¸”æ¥æ”¶å…©å€‹åƒæ•¸
1. `selector`ï¼šå®šç¾©å¦‚ä½•å¾ store state å–å€¼ï¼Œä¾‹å¦‚ `(state) => state.count`
2. `equalityFn`ï¼šå®šç¾© selector é¸å–çš„ store state éƒ¨åˆ†æ˜¯å¦æœ‰æ”¹è®Š

<br /><br />


è©³ç´°æµç¨‹å¦‚ä¸‹ï¼š

```mermaid
flowchart TB
id1["1. å¾ Context å–å¾— store"] -- "store å› ç‚º reference å›ºå®šçš„ï¼Œå°±ç®—å…§éƒ¨çš„ state è¢«æ”¹è®Šï¼Œ<br/>reference é‚„æ˜¯ä¸€æ¨£ï¼Œæ•…ä¸æœƒé€ æˆ component re-render" --> id3["2. å¾ store ä¸­å–å¾— state"]
id3 --> id4["3. åˆ¤æ–·ç›£è½çš„ state è·Ÿä¸Šæ¬¡ state çš„å€¼æœ‰æ²’æœ‰å·®ç•°"]
id4 --> id5["4. å¦‚æœæœ‰å·®ç•°ï¼Œå¼·åˆ¶ re-redner component"]
id5 --> id6["5. å°‡ step 1 ~ step 4 çš„è¡Œç‚ºè¨»å†Šåˆ° redux è£¡"]
```

<br /><br />


ç¨‹å¼ç¢¼å¦‚ä¸‹ï¼š

```tsx showLineNumbers
const defaultEqualityFn = (prevState, curState) => prevState === curState;

export function useSelector(selector, equalityFn = defaultEqualityFn) {
  // 1. å…ˆå–å‡º Redux store
  // 2. ç”¨ selector é¸å– initialState ç›£è½çš„éƒ¨åˆ†ï¼Œæ”¾åˆ° ref è£¡ä½œç‚ºåˆå§‹å€¼
  // 3. çœ‹çœ‹ store ä¸­çš„ state æœ‰æ²’æœ‰è®Šæ›´ï¼Œç”¨ shallow compare è·Ÿ prevState æ¯”è¼ƒæ˜¯å¦ä¸€æ¨£
  // 4. æœ‰è®Šæ›´çš„è©±å°±åˆ©ç”¨ setState å¼·åˆ¶ re-render
  // 5. å°‡ step 4, 5 çš„æ­¥é©Ÿæ”¾åˆ° updateIfChange function ä¸­ï¼Œè¨»å†Šåˆ° redux

  const store = useReduxContext();

  const selectedState = selector(store.getState());
  const prevSelectedState = useRef(selectedState);
  
  const [reRenderTimes, setReRenderTimes] = useState(0);

  const forceReRender = () => {
    setReRenderTimes((prev) => prev + 1);
  }

  const updateIfChange = () => {
    const newSelectedState = selector(store.getState());

    if (equalityFn(prevSelectedState.current, newSelectedState)) {
      return;
    }

    prevSelectedState.current = newSelectedState;
    forceReRender();
  }

  useEffect(() => {
    const unsubscribe = store.subscribe(updateIfChange);

    return unsubscribe;
  }, []);

  return selectedState;
}
```

<br /><br />

è§¸ç™¼ re-render éç¨‹

```mermaid
flowchart TB
id1["1. ç›£è½çš„ state æœ‰è®Šå‹•"] --> id2["2. redux é€šçŸ¥è¨»å†Šçš„æ‰€æœ‰ component"]
id2 --> id3["3. å‘¼å« updateIfChange å‡½å¼"]
id3 --> id4["4. ç¢ºèªç›£è½çš„ state æ˜¯å¦æœ‰è®Šå‹•"]
id4 --> id5["5. è‹¥æœ‰è®Šå‹•ï¼Œå¼·åˆ¶ re-render"]
```

<br /><br /><br />

## simple `react-redux` æ¸¬è©¦

æœ€çµ‚çµæœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘å€‘çœŸçš„æˆåŠŸå„ªåŒ–äº† Context ğŸ¥³ğŸ¥³ğŸ¥³

<br />

<iframe width="720" height="405" src="https://www.youtube.com/embed/8udNka08Uwg?si=dWu5WJvsRYWthuPH" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<br /><br /><br /><br />

## çµè«–

1. Context API æœ‰æ•ˆèƒ½ä¸Šçš„å•é¡Œï¼Œä¸»è¦æ˜¯ä¸€ç›´ç”¢ç”Ÿæ–°çš„ context object é€ æˆçš„
2. react-redux çš„ `useSelector` åˆ©ç”¨äº†å›ºå®šçš„ redux store referenceï¼Œå’Œæ¯”è¼ƒ `useRef` ç´€éŒ„çš„ prevSelectedStateï¼ŒæˆåŠŸé¿å…äº†ä¸å¿…è¦çš„ re-render


<br /><br /><br />

### åƒè€ƒè³‡æº
- [React-Redux 100è¡Œä»£ç ç®€æ˜“ç‰ˆæ¢ç©¶åŸç†ã€‚ï¼ˆé¢è¯•çƒ­ç‚¹ï¼ŒReact Hook + TypeScriptå®ç°ï¼‰-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)](https://cloud.tencent.com/developer/article/1612960)
- [Passing Data Deeply with Context â€“ React](https://react.dev/learn/passing-data-deeply-with-context)


<br /><br /><br />