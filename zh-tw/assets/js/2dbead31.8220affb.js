"use strict";(self.webpackChunkbenson_doc=self.webpackChunkbenson_doc||[]).push([[3795],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>m});var r=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=r.createContext({}),p=function(e){var n=r.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},c=function(e){var n=p(e.components);return r.createElement(s.Provider,{value:n},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},k=r.forwardRef((function(e,n){var t=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(t),k=i,m=u["".concat(s,".").concat(k)]||u[k]||d[k]||o;return t?r.createElement(m,a(a({ref:n},c),{},{components:t})):r.createElement(m,a({ref:n},c))}));function m(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var o=t.length,a=new Array(o);a[0]=k;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[u]="string"==typeof e?e:i,a[1]=l;for(var p=2;p<o;p++)a[p]=t[p];return r.createElement.apply(null,a)}return r.createElement.apply(null,t)}k.displayName="MDXCreateElement"},9579:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var r=t(7462),i=(t(7294),t(3905));const o={sidebar__label:"[React] React Fiber - 2 - \u6df1\u5165 React \u539f\u59cb\u78bc",title:"[React] React Fiber - 2 - \u6df1\u5165 React \u539f\u59cb\u78bc"},a=void 0,l={unversionedId:"Code/react-fiber-2-fiber-deep-dive",id:"Code/react-fiber-2-fiber-deep-dive",title:"[React] React Fiber - 2 - \u6df1\u5165 React \u539f\u59cb\u78bc",description:"\u6b64\u7bc7\u539f\u59cb\u78bc\u89e3\u8aaa\u6587\u4e3b\u8981\u4ee5\u525b\u51fa\u73fe Fiber \u67b6\u69cb\u7684 React v16.0 \u70ba\u4e3b\uff0c\u56e0\u70ba\u76f8\u5c0d\u5b8c\u6574\u548c\u7c21\u55ae\uff0c\u5f8c\u7e8c\u7684\u7248\u672c\u5dee\u7570\u8acb\u81ea\u884c\u53c3\u8003\u5b98\u65b9\u539f\u59cb\u78bc",source:"@site/docs/Code/react-fiber-2-fiber-deep-dive.mdx",sourceDirName:"Code",slug:"/Code/react-fiber-2-fiber-deep-dive",permalink:"/zh-tw/docs/Code/react-fiber-2-fiber-deep-dive",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Code/react-fiber-2-fiber-deep-dive.mdx",tags:[],version:"current",lastUpdatedAt:1733672195,formattedLastUpdatedAt:"2024\u5e7412\u67088\u65e5",frontMatter:{sidebar__label:"[React] React Fiber - 2 - \u6df1\u5165 React \u539f\u59cb\u78bc",title:"[React] React Fiber - 2 - \u6df1\u5165 React \u539f\u59cb\u78bc"},sidebar:"tutorialSidebar",previous:{title:"[React] React Fiber - 1 - \u4ec0\u9ebc\u662f React Fiber?",permalink:"/zh-tw/docs/Code/react-fiber-1-what-is-react-fiber"},next:{title:"[React] useLayoutEffect",permalink:"/zh-tw/docs/Code/useLayoutEffect"}},s={},p=[{value:"Fiber tree",id:"fiber-tree",level:2},{value:"Work Loop",id:"work-loop",level:2},{value:"Fiber node \u7684\u7d50\u69cb",id:"fiber-node-\u7684\u7d50\u69cb",level:2},{value:"<code>tag</code>",id:"tag",level:3},{value:"<code>key</code> &amp; <code>type</code>",id:"key--type",level:3},{value:"<code>child</code>, <code>sibling</code>, <code>return</code>",id:"child-sibling-return",level:3},{value:"<code>pendingWorkPriority</code>",id:"pendingworkpriority",level:3},{value:"<code>pendingProps</code>, <code>memoizedProps</code>",id:"pendingprops-memoizedprops",level:3},{value:"<code>alternate</code>",id:"alternate",level:3},{value:"\u7d50\u8ad6",id:"\u7d50\u8ad6",level:2},{value:"\u53c3\u8003\u8cc7\u6599",id:"\u53c3\u8003\u8cc7\u6599",level:3}],c={toc:p},u="wrapper";function d(e){let{components:n,...t}=e;return(0,i.kt)(u,(0,r.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"\u6b64\u7bc7\u539f\u59cb\u78bc\u89e3\u8aaa\u6587\u4e3b\u8981\u4ee5\u525b\u51fa\u73fe Fiber \u67b6\u69cb\u7684 React v16.0 \u70ba\u4e3b\uff0c\u56e0\u70ba\u76f8\u5c0d\u5b8c\u6574\u548c\u7c21\u55ae\uff0c\u5f8c\u7e8c\u7684\u7248\u672c\u5dee\u7570\u8acb\u81ea\u884c\u53c3\u8003\u5b98\u65b9\u539f\u59cb\u78bc")),(0,i.kt)("h2",{id:"fiber-tree"},"Fiber tree"),(0,i.kt)("p",null,"\u5c31\u50cf HTML DOM \u662f tree data structure\uff0cReact \u7684 Virtual DOM \u4e5f\u662f tree data structure\uff0cReact"),(0,i.kt)("p",null,"\u4f46\u5728\u5167\u90e8\uff0cReact \u6703\u6709\u5169\u500b Virtual DOM tree\uff08\u6216\u7a31 Fiber tree\uff09\uff0c\u4e00\u500b\u662f current tree\uff0c\u53e6\u4e00\u500b\u662f work in progress tree"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Current tree\uff1a\u76ee\u524d\u6b63\u5728\u700f\u89bd\u5668\u6e32\u67d3\u7684 Fiber tree"),(0,i.kt)("li",{parentName:"ul"},"Work in progress tree\uff1a\u6b63\u5728\u8a08\u7b97\u66f4\u65b0\u7684 Fiber tree")),(0,i.kt)("br",null),(0,i.kt)("p",null,"\u800c\u4e14 React \u5167\u90e8\u6703\u6709\u4e00\u500b pointer\uff0c\u6307\u5411\u73fe\u5728\u8981\u6e32\u67d3\u51fa\u4f86\u7684 Fiber tree \u662f\u54ea\u4e00\u500b\uff0c\u7576 Work In Progress Tree \u8a08\u7b97\u5b8c\u6210\u5f8c\uff0c\u6703\u53d6\u4ee3 Current Tree\uff0c\u6210\u70ba\u65b0\u7684 Current Tree\uff0c\u793a\u610f\u52d5\u756b\u5982\u4e0b\uff1a"),(0,i.kt)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/0ympFIwQFJw?clip=UgkxLL9RuKWj8Lj9BD-2P3FEO_Q9KxBpZvE2&clipt=EMj5IxigqiY",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",allowfullscreen:!0}),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("h2",{id:"work-loop"},"Work Loop"),(0,i.kt)("p",null,"\u56e0\u70ba\u72c0\u614b\u66f4\u65b0\u800c\u958b\u59cb\u8a08\u7b97 Work In Progress Tree \u7684\u904e\u7a0b\u4e2d\uff0cReact \u6703\u985e\u4f3c Recursion \u7684\u65b9\u5f0f\uff0c\u8655\u7406 Fiber nodes"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u7576\u5f9e root fiber node \u958b\u59cb\u8a08\u7b97\u6642\uff0c\u6703\u547c\u53eb ",(0,i.kt)("inlineCode",{parentName:"li"},"beginWork")," (",(0,i.kt)("a",{href:"https://github.com/facebook/react/blob/5c6ef4044610a2a325780261f41730a33a919f98/src/renderers/shared/fiber/ReactFiberScheduler.js#L710"},"v16 Line 710"),") \u51fd\u5f0f\uff0c\u751f\u6210\u6216\u66f4\u65b0\u73fe\u5728\u7684 fiber node"),(0,i.kt)("li",{parentName:"ul"},"\u7576\u8a08\u7b97\u5230 leaf fiber node \u6642\uff0c\u6703\u547c\u53eb ",(0,i.kt)("inlineCode",{parentName:"li"},"completeWork"),"(",(0,i.kt)("a",{href:"https://github.com/facebook/react/blob/5c6ef4044610a2a325780261f41730a33a919f98/src/renderers/shared/fiber/ReactFiberScheduler.js#L618"},"v16 Line 618"),") \u51fd\u5f0f\u56de\u5230 parent fiber node")),(0,i.kt)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/0ympFIwQFJw?si=QM7NXhnLT95ulWyc&clip=UgkxVKLmWOIrHycqijRwPEAwQSPCkfRx329y&clipt=ELzENhicmTo",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",referrerpolicy:"strict-origin-when-cross-origin",allowfullscreen:!0}),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("h2",{id:"fiber-node-\u7684\u7d50\u69cb"},"Fiber node \u7684\u7d50\u69cb"),(0,i.kt)("p",null,"\u90a3\u5728\u904d\u6b77\u6bcf\u500b Fiber node \u7684\u904e\u7a0b\u4e2d\uff0c\u7a76\u7adf\u8655\u7406\u4e86\u4ec0\u9ebc\u5462\uff1f \u9019\u5c31\u8981\u4f86\u770b\u770b Fiber node \u7684\u7d50\u69cb\u4e86"),(0,i.kt)("p",null,"Fiber node \u7684\u7d50\u69cb\u5982\u4e0b (",(0,i.kt)("a",{href:"https://github.com/facebook/react/blob/5c6ef4044610a2a325780261f41730a33a919f98/src/renderers/shared/fiber/ReactFiber.js#L64"},"v16 ReactFiber.js Line 64"),")\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx",metastring:"showLineNumbers",showLineNumbers:!0},"export type Fiber = {\n  // These first fields are conceptually members of an Instance. This used to\n  // be split into a separate type and intersected with the other Fiber fields,\n  // but until Flow fixes its intersection bugs, we've merged them into a\n  // single type.\n\n  // An Instance is shared between all versions of a component. We can easily\n  // break this out into a separate object to avoid copying so much to the\n  // alternate versions of the tree. We put this on a single object for now to\n  // minimize the number of objects created during the initial render.\n\n  // Tag identifying the type of fiber.\n  tag: TypeOfWork,\n\n  // Unique identifier of this child.\n  key: null | string,\n\n  // The function/class/module associated with this fiber.\n  type: any,\n\n  return: Fiber | null,\n\n  // Singly Linked List Tree Structure.\n  child: Fiber | null,\n  sibling: Fiber | null,\n  index: number,\n\n\n  // Input is the data coming into process this fiber. Arguments. Props.\n  pendingProps: any, // This type will be more specific once we overload the tag.\n  memoizedProps: any, // The props used to create the output.\n\n  // A queue of state updates and callbacks.\n  updateQueue: UpdateQueue | null,\n\n  // The state used to create the output\n  memoizedState: any,\n\n  // This will be used to quickly determine if a subtree has no pending changes.\n  pendingWorkPriority: PriorityLevel,\n\n  // This is a pooled version of a Fiber. Every fiber that gets updated will\n  // eventually have a pair. There are cases when we can clean up pairs to save\n  // memory if we need to.\n  alternate: Fiber | null,\n\n  ...\n};\n")),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("h3",{id:"tag"},(0,i.kt)("inlineCode",{parentName:"h3"},"tag")),(0,i.kt)("p",null,"tag \u662f\u7d66 React \u5167\u90e8\u8fa8\u8b58\u7528\u7684\uff0c\u7528\u65bc\u5340\u5206\u6b64 Fiber node \u8981\u600e\u9ebc\u8655\u7406\uff0c\u50cf\u662f ",(0,i.kt)("inlineCode",{parentName:"p"},"FunctionComponent"),"\u3001",(0,i.kt)("inlineCode",{parentName:"p"},"ClassComponent"),"\u3001",(0,i.kt)("inlineCode",{parentName:"p"},"HostComponent")," \u7b49\u7b49\uff0c\n\u5728 ",(0,i.kt)("a",{href:"https://github.com/facebook/react/blob/v16.0.0/src/shared/ReactTypeOfWork.js"},(0,i.kt)("inlineCode",{parentName:"p"},"ReactTypeOfWork.js")," file")," \u4e2d\u5b9a\u7fa9\u4e86\u6240\u6709\u53ef\u80fd\u7684 tag \u985e\u578b\uff0c\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"export type TypeOfWork = 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10;\n\nmodule.exports = {\n  IndeterminateComponent: 0, // Before we know whether it is functional or class\n  FunctionalComponent: 1,\n  ClassComponent: 2,\n  HostRoot: 3, // Root of a host tree. Could be nested inside another node.\n  HostPortal: 4, // A subtree. Could be an entry point to a different renderer.\n  HostComponent: 5,\n  HostText: 6,\n  CoroutineComponent: 7,\n  CoroutineHandlerPhase: 8,\n  YieldComponent: 9,\n  Fragment: 10,\n};\n")),(0,i.kt)("br",null),(0,i.kt)("p",null,"\u8209\u4f8b\u4f86\u8aaa\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"function MyButton() {\n  return <button>Click me</button>;\n}\n\n// \u5c0d\u61c9\u7684 Fiber \u7bc0\u9ede\n{\n  tag: FunctionComponent, // \u8868\u793a\u9019\u662f\u4e00\u500b\u51fd\u6578\u7d44\u4ef6\n  // ...\n}\n\n")),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("p",null,"\u4f7f\u7528\u7684\u60c5\u5883\uff0c\u50cf\u662f\u5728",(0,i.kt)("a",{href:"https://github.com/facebook/react/blob/5c6ef4044610a2a325780261f41730a33a919f98/src/renderers/shared/fiber/ReactFiberBeginWork.js#L716"},"\u539f\u59cb\u78bc\u4e2d ",(0,i.kt)("inlineCode",{parentName:"p"},"beginWork")," \u51fd\u5f0f"),"\u4e2d\uff0c\u6703\u6839\u64da tag \u985e\u578b\uff0c\u6c7a\u5b9a\u8981\u66f4\u65b0 Fiber node \u7684\u65b9\u5f0f\uff0c\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"function beginWork(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  priorityLevel: PriorityLevel,\n): Fiber | null {\n  if (\n    workInProgress.pendingWorkPriority === NoWork ||\n      workInProgress.pendingWorkPriority > priorityLevel\n    ) {\n      return bailoutOnLowPriority(current, workInProgress);\n    }\n\n    if (__DEV__) {\n      ReactDebugCurrentFiber.setCurrentFiber(workInProgress, null);\n    }\n\n    // highlight-start\n    switch (workInProgress.tag) {\n    // highlight-end\n      case IndeterminateComponent:\n        return mountIndeterminateComponent(\n          current,\n          workInProgress,\n          priorityLevel,\n        );\n      case FunctionalComponent:\n        return updateFunctionalComponent(current, workInProgress);\n      case ClassComponent:\n        return updateClassComponent(current, workInProgress, priorityLevel);\n      case HostRoot:\n        return updateHostRoot(current, workInProgress, priorityLevel);\n      case HostComponent:\n        return updateHostComponent(current, workInProgress, priorityLevel);\n      case HostText:\n        return updateHostText(current, workInProgress);\n      case CoroutineHandlerPhase:\n        // This is a restart. Reset the tag to the initial phase.\n        workInProgress.tag = CoroutineComponent;\n      // Intentionally fall through since this is now the same.\n      case CoroutineComponent:\n        return updateCoroutineComponent(current, workInProgress);\n      case YieldComponent:\n        // A yield component is just a placeholder, we can just run through the\n        // next one immediately.\n        return null;\n      case HostPortal:\n        return updatePortalComponent(current, workInProgress);\n      case Fragment:\n        return updateFragment(current, workInProgress);\n      default:\n        invariant(\n        false,\n        'Unknown unit of work tag. This error is likely caused by a bug in ' +\n        'React. Please file an issue.',\n      );\n  }\n}\n")),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("h3",{id:"key--type"},(0,i.kt)("inlineCode",{parentName:"h3"},"key")," & ",(0,i.kt)("inlineCode",{parentName:"h3"},"type")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"key")," \u548c ",(0,i.kt)("inlineCode",{parentName:"p"},"type")," \u7684\u4e3b\u8981\u76ee\u7684\u90fd\u662f\u7528\u4f86\u8fa8\u8b58 Fiber node \u8ddf\u820a\u7684 Fiber node \u662f\u5426\u76f8\u540c\uff0c\u4ee5\u6c7a\u5b9a\u662f\u5426\u53ef\u4ee5\u5fa9\u7528\u820a\u7684 Fiber node"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"key"),"\uff1aFiber node \u7684 id\uff0c\u7528\u65bc\u8b58\u5225\u540c\u4e00\u500b\u7236\u7bc0\u9ede\u4e0b\u7684\u5b50\u7bc0\u9ede"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"type"),"\uff1a\u6307\u5230\u5c0d\u61c9\u7684 element \u985e\u578b\uff0c\u5982\u679c\u662f Component\uff0c\u5c31\u662f\u5c0d\u61c9 Component \u7684\u540d\u7a31\uff0c\u5982\u679c\u662f DOM element\uff0c\u5c31\u662f\u5c0d\u61c9\u7684 DOM tag name")),(0,i.kt)("br",null),(0,i.kt)("p",null,"\u8209\u4f8b\u4f86\u8aaa\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"function MyButton() {\n  return <button>Click me</button>;\n}\n\n// \u5c0d\u61c9\u7684 Fiber \u7bc0\u9ede\n{\n  type: MyButton, // \u6307\u5411 MyButton \u51fd\u6578\n  // ...\n}\n\n{\n  type: 'button', // \u6307\u5411 button DOM element\n  // ...\n}\n")),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("p",null,"\u5728",(0,i.kt)("a",{href:"https://github.com/facebook/react/blob/5c6ef4044610a2a325780261f41730a33a919f98/src/renderers/shared/fiber/ReactChildFiber.js#L1133"},"\u539f\u59cb\u78bc ",(0,i.kt)("inlineCode",{parentName:"p"},"ReactChildFiber.js")),"\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230 ",(0,i.kt)("inlineCode",{parentName:"p"},"key")," \u548c ",(0,i.kt)("inlineCode",{parentName:"p"},"type")," \u7684\u7528\u9014\uff0c\n\u5c31\u662f reconciliation \u7684\u6838\u5fc3\u908f\u8f2f\uff1a"),(0,i.kt)("blockquote",null,(0,i.kt)("ol",{parentName:"blockquote"},(0,i.kt)("li",{parentName:"ol"},"\u5617\u8a66\u8986\u7528\u73fe\u6709 Fiber \u7bc0\u9ede\uff1a\u9010\u4e00\u6aa2\u67e5\u7576\u524d\u7684 Fiber \u7bc0\u9ede\uff08currentFirstChild \u548c\u5b83\u7684 siblings\uff09\uff0c\u5224\u65b7\u5b83\u5011\u662f\u5426\u53ef\u4ee5\u8986\u7528\u3002")),(0,i.kt)("ul",{parentName:"blockquote"},(0,i.kt)("li",{parentName:"ul"},"\u5982\u679c\u53ef\u4ee5\u8986\u7528\uff0c\u66f4\u65b0\u8a72\u7bc0\u9ede\u7684\u76f8\u95dc\u5c6c\u6027\uff08props\u3001ref \u7b49\uff09\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u5982\u679c\u4e0d\u80fd\u8986\u7528\uff0c\u5247\u522a\u9664\u820a\u7bc0\u9ede\u3002",(0,i.kt)("br",null),(0,i.kt)("br",null))),(0,i.kt)("ol",{parentName:"blockquote",start:2},(0,i.kt)("li",{parentName:"ol"},"\u6bd4\u8f03\u7684\u6838\u5fc3\u689d\u4ef6\uff1a")),(0,i.kt)("ul",{parentName:"blockquote"},(0,i.kt)("li",{parentName:"ul"},"key \u662f\u5426\u76f8\u540c\uff1aReact \u4f7f\u7528 key \u4f86\u552f\u4e00\u6a19\u8b58\u5217\u8868\u4e2d\u7684\u6bcf\u500b\u5143\u7d20\u3002\u5982\u679c key \u4e0d\u540c\uff0c\u5247\u8a8d\u70ba\u662f\u5168\u65b0\u7684\u7bc0\u9ede\uff0c\u522a\u9664\u820a\u7bc0\u9ede\u3002"),(0,i.kt)("li",{parentName:"ul"},"type \u662f\u5426\u76f8\u540c\uff1a\u5373\u4f7f key \u76f8\u540c\uff0c\u9084\u9700\u6aa2\u67e5\u7bc0\u9ede\u985e\u578b\u662f\u5426\u4e00\u81f4\uff08\u4f8b\u5982 div \u8207 span \u662f\u4e0d\u540c\u7684 type\uff09\u3002",(0,i.kt)("br",null),(0,i.kt)("br",null))),(0,i.kt)("ol",{parentName:"blockquote",start:3},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u82e5\u7121\u6cd5\u8986\u7528\uff0c\u5247\u522a\u9664\u820a\u7bc0\u9ede\uff0c\u4e26\u70ba\u65b0\u7684 ReactElement \u5275\u5efa\u4e00\u500b\u65b0\u7684 Fiber \u7bc0\u9ede\u3002")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u5f80 sibling \u79fb\u52d5\uff1a\u5982\u679c\u7576\u524d\u7bc0\u9ede\u7121\u6cd5\u8986\u7528\uff0c\u6703\u7e7c\u7e8c\u6aa2\u67e5\u5b83\u7684 sibling\uff0c\u76f4\u5230\u6240\u6709\u53ef\u80fd\u8986\u7528\u7684\u7bc0\u9ede\u90fd\u88ab\u6aa2\u67e5\u5b8c\u7562")))),(0,i.kt)("br",null),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"function reconcileSingleElement(\n    returnFiber: Fiber,\n    currentFirstChild: Fiber | null,\n    element: ReactElement,\n    priority: PriorityLevel,\n): Fiber {\n    const key = element.key;\n    let child = currentFirstChild;\n    while (child !== null) {\n      // TODO: If key === null and child.key === null, then this only applies to\n      // the first item in the list.\n      // highlight-start\n      if (child.key === key) {\n        if (child.type === element.type) {\n          // highlight-end\n          deleteRemainingChildren(returnFiber, child.sibling);\n          const existing = useFiber(child, priority);\n          existing.ref = coerceRef(child, element);\n          existing.pendingProps = element.props;\n          existing.return = returnFiber;\n          if (__DEV__) {\n            existing._debugSource = element._source;\n            existing._debugOwner = element._owner;\n          }\n          return existing;\n        } else {\n          deleteRemainingChildren(returnFiber, child);\n          break;\n        }\n      } else {\n        deleteChild(returnFiber, child);\n      }\n      child = child.sibling;\n    }\n}\n")),(0,i.kt)("br",null),(0,i.kt)("h3",{id:"child-sibling-return"},(0,i.kt)("inlineCode",{parentName:"h3"},"child"),", ",(0,i.kt)("inlineCode",{parentName:"h3"},"sibling"),", ",(0,i.kt)("inlineCode",{parentName:"h3"},"return")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"child"),"\uff1a\u73fe\u5728 fiber node \u7684\u7b2c\u4e00\u500b\u5b50 node"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"sibling"),"\uff1a\u73fe\u5728 fiber node \u7684\u4e0b\u4e00\u500b\u9130\u8fd1\u7684 node"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"return"),"\uff1a\u73fe\u5728 fiber node \u7684 parent node\uff0c\u5728\u57f7\u884c ",(0,i.kt)("inlineCode",{parentName:"li"},"completeWork")," \u6703\u56de\u5230\u7684 fiber node")),(0,i.kt)("br",null),(0,i.kt)("h3",{id:"pendingworkpriority"},(0,i.kt)("inlineCode",{parentName:"h3"},"pendingWorkPriority")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"pendingWorkPriority")," \u7528\u65bc\u5b9a\u7fa9 Fiber node \u7684\u512a\u5148\u7d1a\uff0c\u6839\u64da v16 \u7684\u539f\u59cb\u78bc\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"pendingWorkPriority")," \u7684 Type \u70ba ",(0,i.kt)("inlineCode",{parentName:"p"},"PriorityLevel"),"\uff0c\u4e26\u5b9a\u7fa9\u4e86 5 \u7a2e\u512a\u5148\u7d1a\uff0c\u5206\u5225\u662f\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"export type PriorityLevel = 0 | 1 | 2 | 3 | 4 | 5;\n\nmodule.exports = {\n  NoWork: 0, // No work is pending.\n  SynchronousPriority: 1, // For controlled text inputs. Synchronous side-effects.\n  TaskPriority: 2, // Completes at the end of the current tick.\n  HighPriority: 3, // Interaction that needs to complete pretty soon to feel responsive.\n  LowPriority: 4, // Data fetching, or result from updating stores.\n  OffscreenPriority: 5, // Won't be visible but do the work in case it becomes visible.\n};\n")),(0,i.kt)("p",null,"\u6211\u5011\u53ef\u4ee5\u770b\u5230"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"SynchronousPriority"),"\uff1a\u540c\u6b65\u7684\u512a\u5148\u7d1a\uff0c\u7528\u65bc\u63a7\u5236\u6587\u5b57\u8f38\u5165\u7b49\u540c\u6b65\u7684 side-effects\uff0c\u70ba\u6700\u9ad8\u7684\u512a\u5148\u7d1a"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"TaskPriority"),"\uff1a\u5728\u7576\u524d ",(0,i.kt)("a",{href:"https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/async%20%26%20performance/ch1.md#:~:text=each%20iteration%20of%20this%20loop%20is%20called%20a%20%22tick.%22"},"tick \uff08\u4e5f\u5c31\u662f\u6bcf\u4e00\u6b21 Event Loop \u7684\u5faa\u74b0)")," \u7d50\u675f\u6642\u5b8c\u6210\u7684\u512a\u5148\u7d1a\uff0c\u70ba\u7b2c\u4e8c\u9ad8\u7684\u512a\u5148\u7d1a"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"HighPriority"),"\uff1a\u7528\u65bc\u9700\u8981\u5feb\u901f\u97ff\u61c9\u7684\u4ea4\u4e92\uff0c\u4f8b\u5982\u9ede\u64ca\u3001\u8f38\u5165\u7b49\uff0c\u70ba\u7b2c\u4e09\u9ad8\u7684\u512a\u5148\u7d1a"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"LowPriority"),"\uff1a\u7528\u65bc\u6578\u64da\u7372\u53d6\u6216\u66f4\u65b0 store \u7b49\uff0c\u70ba\u7b2c\u56db\u9ad8\u7684\u512a\u5148\u7d1a"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"OffscreenPriority"),"\uff1a\u4e0d\u6703\u986f\u793a\u5728\u756b\u9762\u4e0a\u7684 Task\uff0c\u7528\u65bc\u4e0d\u6703\u7acb\u5373\u986f\u793a\u4f46\u53ef\u80fd\u5728\u986f\u793a\u6642\u9700\u8981\u5b8c\u6210\u7684\u5de5\u4f5c\uff0c\u70ba\u6700\u4f4e\u7684\u512a\u5148\u7d1a")),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("p",null,"\u5c0d\u65bc\u512a\u5148\u9806\u5e8f\u5927\u65bc ",(0,i.kt)("inlineCode",{parentName:"p"},"TaskPriority"),"\uff08\u4e5f\u5c31\u662f ",(0,i.kt)("inlineCode",{parentName:"p"},"PriorityLevel > 2"),"\uff09 \u7684\u66f4\u65b0\uff0cReact \u6703\u4f7f\u7528 ",(0,i.kt)("a",{href:"https://github.com/facebook/react/blob/5c6ef4044610a2a325780261f41730a33a919f98/src/renderers/shared/fiber/ReactFiberScheduler.js#L1073"},(0,i.kt)("inlineCode",{parentName:"p"},"scheduleDeferredCallback"))," \u4f86\u8655\u7406\uff0c"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"if (nextPriorityLevel > TaskPriority && !isCallbackScheduled) {\n    scheduleDeferredCallback(performDeferredWork);\n    isCallbackScheduled = true;\n}\n")),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("p",null,"\u800c ",(0,i.kt)("a",{href:"https://github.com/facebook/react/blob/5c6ef4044610a2a325780261f41730a33a919f98/src/renderers/dom/fiber/ReactDOMFiberEntry.js#L548"}," ",(0,i.kt)("inlineCode",{parentName:"p"},"scheduleDeferredCallback")," \u5c31\u662f\u4f7f\u7528\u4e86 ",(0,i.kt)("inlineCode",{parentName:"p"},"requestIdleCallback")),"\uff0c\u4f86\u9054\u5230\u5728\u700f\u89bd\u5668\u6bcf\u5e40\u6e32\u67d3\u7684\u7a7a\u9591\u6642\u9593\u4e2d\u57f7\u884c\uff0c\u4f7f\u756b\u9762\u4e0d\u6703\u5361\u9813"),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("mdxAdmonitionTitle",{parentName:"admonition"},(0,i.kt)("inlineCode",{parentName:"mdxAdmonitionTitle"},"requestAnimationFrame")," Task"),(0,i.kt)("p",{parentName:"admonition"},"\u96d6\u7136\u5728 v16 \u4e2d\uff0cReact \u5df2\u7d93\u4e0d\u518d\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"requestAnimationFrame")," \u4f86\u8655\u7406\u52d5\u756b\u76f8\u95dc\u7684\u66f4\u65b0\uff0c\u4f46\u5728\u6bd4 v16 \u66f4\u65e9\u7684\u7248\u672c\u4e2d\uff0cReact \u4e5f\u6709\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"requestAnimationFrame")," \u4f86\u8655\u7406\u52d5\u756b\u76f8\u95dc\u7684\u66f4\u65b0\uff0c(",(0,i.kt)("a",{href:"https://github.com/facebook/react/blob/ab02a03cad1afcecfdb88bc4b1013b46bc51dff2/src/renderers/dom/fiber/ReactDOMFiber.js#L111"},"source code"),")"),(0,i.kt)("p",{parentName:"admonition"},"\u5f8c\u7e8c\u5728 Concurrent \u529f\u80fd\u51fa\u4f86\u5f8c\uff0cReact \u4e5f\u6709\u6062\u5fa9\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"requestAnimationFrame")," \u4f86\u5be6\u73fe Concurrent features")),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("h3",{id:"pendingprops-memoizedprops"},(0,i.kt)("inlineCode",{parentName:"h3"},"pendingProps"),", ",(0,i.kt)("inlineCode",{parentName:"h3"},"memoizedProps")),(0,i.kt)("p",null,"\u9019\u5169\u500b\u5c6c\u6027\uff0c\u4e3b\u8981\u662f\u8981\u7576\u524d & \u8981\u66f4\u65b0\u7684 props\uff0c\u7528\u4f86\u6c7a\u5b9a Fiber node \u662f\u5426\u9700\u8981\u66f4\u65b0"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"pendingProps"),"\uff1a\u7576\u524d Fiber node \u6e96\u5099\u66f4\u65b0\u7684 props"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"memoizedProps"),"\uff1a\u7576\u524d Fiber node \u7684 props")),(0,i.kt)("br",null),(0,i.kt)("p",null,"\u4f8b\u5982\u5728 ",(0,i.kt)("a",{href:"https://github.com/facebook/react/blob/5c6ef4044610a2a325780261f41730a33a919f98/src/renderers/shared/fiber/ReactFiberBeginWork.js#L184"},(0,i.kt)("inlineCode",{parentName:"p"},"ReactFiberBeginWork.js")," \u4e2d\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"updateFunctionalComponent")," \u51fd\u5f0f"),"\u4e2d\uff0c\n\u53ef\u4ee5\u770b\u5230 ",(0,i.kt)("inlineCode",{parentName:"p"},"pendingProps")," \u548c ",(0,i.kt)("inlineCode",{parentName:"p"},"memoizedProps")," \u7684\u7528\u9014\uff1a"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"\u7576\u6211\u5011\u767c\u73fe ",(0,i.kt)("inlineCode",{parentName:"p"},"pendingProps")," \u548c ",(0,i.kt)("inlineCode",{parentName:"p"},"memoizedProps")," \u76f8\u540c\u6642\uff0c\u6211\u5011\u53ef\u4ee5\u8df3\u904e\u66f4\u65b0\uff0c\u76f4\u63a5 clone child fiber nodes")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"function updateFunctionalComponent(current, workInProgress) {\n    var fn = workInProgress.type;\n    var nextProps = workInProgress.pendingProps;\n\n    const memoizedProps = workInProgress.memoizedProps;\n    if (hasContextChanged()) {\n      // Normally we can bail out on props equality but if context has changed\n      // we don't do the bailout and we have to reuse existing props instead.\n      if (nextProps === null) {\n        nextProps = memoizedProps;\n      }\n    } else {\n      // highlight-start\n      if (nextProps === null || memoizedProps === nextProps) {\n        return bailoutOnAlreadyFinishedWork(current, workInProgress);\n      }\n      // highlight-end\n      // TODO: consider bringing fn.shouldComponentUpdate() back.\n      // It used to be here.\n    }\n\n    var unmaskedContext = getUnmaskedContext(workInProgress);\n    var context = getMaskedContext(workInProgress, unmaskedContext);\n\n    var nextChildren;\n\n    if (__DEV__) {\n      ReactCurrentOwner.current = workInProgress;\n      ReactDebugCurrentFiber.setCurrentFiber(workInProgress, 'render');\n      nextChildren = fn(nextProps, context);\n      ReactDebugCurrentFiber.setCurrentFiber(workInProgress, null);\n    } else {\n      nextChildren = fn(nextProps, context);\n    }\n    // React DevTools reads this flag.\n    workInProgress.effectTag |= PerformedWork;\n    reconcileChildren(current, workInProgress, nextChildren);\n    memoizeProps(workInProgress, nextProps);\n    return workInProgress.child;\n  }\n\n  ...\n\n// highlight-start\nfunction bailoutOnAlreadyFinishedWork(\n// highlight-end\n    current,\n    workInProgress: Fiber,\n): Fiber | null {\n    if (__DEV__) {\n      cancelWorkTimer(workInProgress);\n    }\n\n    // TODO: We should ideally be able to bail out early if the children have no\n    // more work to do. However, since we don't have a separation of this\n    // Fiber's priority and its children yet - we don't know without doing lots\n    // of the same work we do anyway. Once we have that separation we can just\n    // bail out here if the children has no more work at this priority level.\n    // if (workInProgress.priorityOfChildren <= priorityLevel) {\n    //   // If there are side-effects in these children that have not yet been\n    //   // committed we need to ensure that they get properly transferred up.\n    //   if (current && current.child !== workInProgress.child) {\n    //     reuseChildrenEffects(workInProgress, child);\n    //   }\n    //   return null;\n    // }\n\n    // highlight-start\n    cloneChildFibers(current, workInProgress);\n    // highlight-end\n    return workInProgress.child;\n}\n")),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("h3",{id:"alternate"},(0,i.kt)("inlineCode",{parentName:"h3"},"alternate")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"alternate")," \u8b93 React \u53ef\u4ee5\u5be6\u73fe reconcilation \u7684\u6a5f\u5236\uff0c\u5c0d\u65bc workInProgress tree\uff0c\u6211\u5011\u53ef\u4ee5\u6307\u5411 current tree \u7684\u6bcf\u4e00\u500b Fiber node\uff0c\u4ee5\u6c7a\u5b9a\u662f\u5426\u53ef\u4ee5\u5fa9\u7528\u820a\u7684"),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("h2",{id:"\u7d50\u8ad6"},"\u7d50\u8ad6"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"React Fiber \u7684\u5e95\u5c64\u6703\u6709\u5169\u500b tree data structure\uff0c\u5206\u5225\u662f current tree \u548c workInProgress tree"),(0,i.kt)("li",{parentName:"ul"},"React Work Loop \u662f Fiber \u5e95\u5c64\u904d\u6b77\u6240\u6709 Fiber node \u7684\u904e\u7a0b\uff0c\u6703\u547c\u53eb ",(0,i.kt)("inlineCode",{parentName:"li"},"beginWork")," \u548c ",(0,i.kt)("inlineCode",{parentName:"li"},"completeWork")," \u51fd\u5f0f\uff0c\u751f\u6210\u6216\u66f4\u65b0 Fiber node"),(0,i.kt)("li",{parentName:"ul"},"Fiber node \u7684\u7d50\u69cb\u4e2d\u5305\u542b\u4ee5\u4e0b\u5c6c\u6027",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"tag"),"\uff1a\u7528\u65bc\u5167\u90e8\u5340\u5206 Fiber node \u7684\u985e\u578b\uff0c\u6c7a\u5b9a\u8981\u600e\u9ebc\u8655\u7406\u6b64\u985e\u578b\u7684 Fiber node\uff0c\u4f8b\u5982 ",(0,i.kt)("inlineCode",{parentName:"li"},"ClassComponent")," \u548c ",(0,i.kt)("inlineCode",{parentName:"li"},"FunctionalComponent")," \u7684\u8655\u7406\u65b9\u5f0f\u5c31\u4e0d\u592a\u4e00\u6a23"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"key")," \u548c ",(0,i.kt)("inlineCode",{parentName:"li"},"type"),"\uff1a\u7528\u65bc\u8b58\u5225 Fiber node \u8ddf\u820a\u7684 Fiber node \u662f\u5426\u76f8\u540c"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"child"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"sibling"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"return"),"\uff1a\u7528\u65bc\u6c7a\u5b9a\u6bcf\u500b Fiber node \u7684\u904d\u6b77\u9806\u5e8f"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"pendingWorkPriority"),"\uff1a\u7528\u65bc\u5b9a\u7fa9 Fiber node \u7684\u512a\u5148\u7d1a\uff0c\u6b21\u8981\u7684\u6703\u7528 ",(0,i.kt)("inlineCode",{parentName:"li"},"requestIdleCallback")," \u4f86\u8655\u7406\uff0c\u907f\u514d\u963b\u585e\u4e3b\u57f7\u884c\u7dd2"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"pendingProps")," \u548c ",(0,i.kt)("inlineCode",{parentName:"li"},"memoizedProps"),"\uff1a\u7528\u65bc\u6c7a\u5b9a Fiber node \u662f\u5426\u9700\u8981\u66f4\u65b0"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"alternate"),"\uff1a\u7528\u65bc\u5be6\u73fe reconcilation \u7684\u6a5f\u5236")))),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("h3",{id:"\u53c3\u8003\u8cc7\u6599"},"\u53c3\u8003\u8cc7\u6599"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.youtube.com/watch?v=0ympFIwQFJw"},"What Is React Fiber? React.js Deep Dive #2")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/facebook/react/tree/v16.0.0"},"React v16.0 source code")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/acdlite/react-fiber-architecture"},"Vercel & ex-React Core Team member - Andrew Clark - React Fiber Architecture"))),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("br",null))}d.isMDXComponent=!0}}]);